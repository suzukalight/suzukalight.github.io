{"componentChunkName":"component---src-components-templates-blog-post-source-github-js","path":"/2019-12-31-graphql-server-pagination/","webpackCompilationHash":"9d92a21a48f2254cf2ed","result":{"data":{"site":{"siteMetadata":{"title":"suzukalight.com","author":"suzukalight"}},"markdownRemark":{"id":"61b27967-5ce5-5d99-a16f-8ed94e941bd7","excerpt":"Apollo-Server を使った GraphQL サーバのハンズオン実装シリーズ。今回はページネーション（Pagination）を扱います。エンティティの数が増えると、findAll による Fetch…","html":"<p>Apollo-Server を使った GraphQL サーバのハンズオン実装シリーズ。今回は<strong>ページネーション（Pagination）</strong>を扱います。</p>\n<p>エンティティの数が増えると、findAll による Fetch のコストがかかってきます。これをすべて操作したり、ダウンロードしたりすると、パフォーマンスが低下し、ひいては UX の低下につながってしまいます。</p>\n<p>ページネーションは、データの一部を切り取ってアクセスできる仕組みです。必要な情報のみを操作することができ、パフォーマンスを高い状態で維持することができます。この仕組みはあとから導入することもできますが、はじめから導入しておくほうが移行コストが安いため、積極的に導入することをおすすめします。</p>\n<p>今回も、こちらのチュートリアルをなぞって進めています；\n<a href=\"https://www.robinwieruch.de/graphql-apollo-server-tutorial\" target=\"_blank\" rel=\"noopener\">https://www.robinwieruch.de/graphql-apollo-server-tutorial</a></p>\n<p>今回実装したリポジトリはこちらです；<br>\n<a href=\"https://github.com/suzukalight/study-graphql-apollo-server/tree/master/src/08-pagination\" target=\"_blank\" rel=\"noopener\">https://github.com/suzukalight/study-graphql-apollo-server/tree/master/src/08-pagination</a></p>\n<h1 id=\"offsetlimit-形式のページネーション\"><a href=\"#offsetlimit-%E5%BD%A2%E5%BC%8F%E3%81%AE%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%8D%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\" aria-label=\"offsetlimit 形式のページネーション permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Offset/Limit 形式のページネーション</h1>\n<p>「要素の M 番目から N 個を取り出す」という形式のページネーションです。素朴な実装で大きな効果を挙げられるため、はじめに提供すべきページネーションと言えます。</p>\n<p>Message スキーマの messages クエリに offset/limit を追加してみます；</p>\n<div class=\"gatsby-code-title\">src/08-pagination/src/schema/message.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  extend type Query {\n<span class=\"gatsby-highlight-code-line\">    messages(offset: Int, limit: Int): [Message!]!</span>  }\n`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Sequelize の findAll は、offset/limit 形式のページネーション処理に対応していますので、これをオプションとして指定します；</p>\n<div class=\"gatsby-code-title\">src/08-pagination/src/resolvers/message.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> resolvers<span class=\"token punctuation\">:</span> IResolvers<span class=\"token operator\">&lt;</span>Message<span class=\"token punctuation\">,</span> ResolverContext<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Query<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token function-variable function\">messages</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> limit <span class=\"token operator\">=</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> models <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span></span><span class=\"gatsby-highlight-code-line\">      models<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> offset<span class=\"token punctuation\">,</span> limit <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>messages クエリを実行してみましょう。引数に <code class=\"language-text\">offset: 1, limit: 2</code> を与えて実行してみます；</p>\n<div class=\"gatsby-code-title\">query</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n  messages<span class=\"token punctuation\">(</span><span class=\"token attr-name\">offset</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">limit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    id\n    text\n    user <span class=\"token punctuation\">{</span>\n      username\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"messages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #2\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"suzuka light\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #3\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"suzuka light\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>offset が 1 つずれて、id=2 の Message から取得が開始しています。</p>\n<h1 id=\"カーソルベースページネーション（cursor-based）\"><a href=\"#%E3%82%AB%E3%83%BC%E3%82%BD%E3%83%AB%E3%83%99%E3%83%BC%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%8D%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%EF%BC%88cursor-based%EF%BC%89\" aria-label=\"カーソルベースページネーション（cursor based） permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カーソルベースページネーション（Cursor-based）</h1>\n<p>オフセットベースのページネーションは簡便ですが、ページネーション中にデータの更新があった場合、オフセットがずれてしまい、正しいページネーションを行うことができなくなってしまいます。</p>\n<p>カーソルベースのページネーションは、カーソルと呼ばれる識別子を用いて、「どこまで情報を取得したか」を管理する手法です。オフセットだと「情報の何番目か」を指定するためズレが生じますが、カーソルだと「どの情報まで取得したか」が管理できるため、ページネーションにズレが生じません。</p>\n<h2 id=\"edges-と-pageinfo\"><a href=\"#edges-%E3%81%A8-pageinfo\" aria-label=\"edges と pageinfo permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>edges と PageInfo</h2>\n<p>新たにカーソルを返すために、PageInfo 型を加えます。もとの message 情報は edges という「情報の断片」を表すフィールドに詰めて返すようにします。これらの情報を MessageConnection という型で表現します；</p>\n<div class=\"gatsby-code-title\">src/08-pagination/src/schema/message.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  extend type Query {\n<span class=\"gatsby-highlight-code-line\">    messages(cursor: String, limit: Int): MessageConnection!</span>  }\n\n<span class=\"gatsby-highlight-code-line\">  type MessageConnection {</span><span class=\"gatsby-highlight-code-line\">    edges: [Message!]!</span><span class=\"gatsby-highlight-code-line\">    pageInfo: PageInfo!</span><span class=\"gatsby-highlight-code-line\">  }</span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">  type PageInfo {</span><span class=\"gatsby-highlight-code-line\">    endCursor: Date!</span><span class=\"gatsby-highlight-code-line\">  }</span>`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>カーソルは createdAt で管理します。findAll の where 条件にカーソルとして受け取った createdAt を渡すことで、それより古い情報だけを fetch するように実装します。</p>\n<p>次のカーソルは、fetch した情報のなかの、末尾のエレメントの createdAt を返します。これによって次のページネーションは、末尾の次の情報であることを特定できます；</p>\n<div class=\"gatsby-code-title\">src/08-pagination/src/resolvers/message.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> resolvers<span class=\"token punctuation\">:</span> IResolvers<span class=\"token operator\">&lt;</span>Message<span class=\"token punctuation\">,</span> ResolverContext<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Query<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token function-variable function\">messages</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> cursor<span class=\"token punctuation\">,</span> limit <span class=\"token operator\">=</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> models <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> cursorOptions <span class=\"token operator\">=</span> cursor</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">            where<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> createdAt<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>Op<span class=\"token punctuation\">.</span>lt<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> cursor <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">          <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> messages <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        order<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'createdAt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'DESC'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        limit<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token operator\">...</span>cursorOptions<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        edges<span class=\"token punctuation\">:</span> messages<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        pageInfo<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> endCursor<span class=\"token punctuation\">:</span> messages<span class=\"token punctuation\">[</span>messages<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>createdAt <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Fetch を実行してみます；</p>\n<div class=\"gatsby-code-title\">query</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n  messages<span class=\"token punctuation\">(</span><span class=\"token attr-name\">limit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    edges <span class=\"token punctuation\">{</span>\n      text\n    <span class=\"token punctuation\">}</span>\n    pageInfo <span class=\"token punctuation\">{</span>\n      endCursor\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"messages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"edges\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #5\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #4\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"pageInfo\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"endCursor\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2019-12-15T10:29:52.026Z\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>edges として最初の 2 件が、pageInfo として 2 件目の createdAt が返されました。</p>\n<p>つづけてこのカーソルを指定してみましょう；</p>\n<div class=\"gatsby-code-title\">query</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n  messages<span class=\"token punctuation\">(</span><span class=\"token attr-name\">limit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">cursor</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2019-12-15T10:29:52.026Z\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    edges <span class=\"token punctuation\">{</span>\n      text\n    <span class=\"token punctuation\">}</span>\n    pageInfo <span class=\"token punctuation\">{</span>\n      endCursor\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"messages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"edges\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #3\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #2\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"pageInfo\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"endCursor\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2019-12-15T10:29:50.026Z\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">#4</code> より 1 つ古い、<code class=\"language-text\">#3</code> からデータが返ってきました、成功です！</p>\n<h2 id=\"次のページがあるかフラグの追加\"><a href=\"#%E6%AC%A1%E3%81%AE%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%8C%E3%81%82%E3%82%8B%E3%81%8B%E3%83%95%E3%83%A9%E3%82%B0%E3%81%AE%E8%BF%BD%E5%8A%A0\" aria-label=\"次のページがあるかフラグの追加 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>次のページがあるかフラグの追加</h2>\n<p>現在のページネーションは、情報をすべて Fetch し終わったかの判別はできないため、ユーザに対して「まだ情報があるぞ」と誤った情報を与えてしまいます。これを防ぐための hasNextPage フラグを付けてみましょう；</p>\n<div class=\"gatsby-code-title\">src/08-pagination/src/schema/message.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  type PageInfo {\n<span class=\"gatsby-highlight-code-line\">    hasNextPage: Boolean!</span>    endCursor: Date!\n  }\n`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>hasNextPage は、limit+1 まで fetch してみた情報が、limit 以下しか返ってこなかったかで判定できます。これを計算して、pageInfo に詰めて返します；</p>\n<div class=\"gatsby-code-title\">src/08-pagination/src/resolvers/message.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> resolvers<span class=\"token punctuation\">:</span> IResolvers<span class=\"token operator\">&lt;</span>Message<span class=\"token punctuation\">,</span> ResolverContext<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Query<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">messages</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> cursor<span class=\"token punctuation\">,</span> limit <span class=\"token operator\">=</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> models <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> cursorOptions <span class=\"token operator\">=</span> cursor\n        <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n            where<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> createdAt<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>Op<span class=\"token punctuation\">.</span>lt<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> cursor <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> messages <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        order<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'createdAt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'DESC'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">        limit<span class=\"token punctuation\">:</span> limit <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></span>        <span class=\"token operator\">...</span>cursorOptions<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> hasNextPage <span class=\"token operator\">=</span> messages<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> limit<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> edges <span class=\"token operator\">=</span> hasNextPage <span class=\"token operator\">?</span> messages<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> messages<span class=\"token punctuation\">;</span></span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        edges<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        pageInfo<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> hasNextPage<span class=\"token punctuation\">,</span> endCursor<span class=\"token punctuation\">:</span> edges<span class=\"token punctuation\">[</span>edges<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>createdAt <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>fetch してみましょう；</p>\n<div class=\"gatsby-code-title\">query</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n  messages<span class=\"token punctuation\">(</span><span class=\"token attr-name\">limit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    edges <span class=\"token punctuation\">{</span>\n      text\n    <span class=\"token punctuation\">}</span>\n    pageInfo <span class=\"token punctuation\">{</span>\n      hasNextPage\n      endCursor\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"messages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"edges\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #5\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #4\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"pageInfo\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"hasNextPage\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"endCursor\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2019-12-15T10:37:48.245Z\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>hasNextPage が返され、次の情報があることがわかるようになりました、成功です！</p>\n<h2 id=\"cursor-のハッシュ化\"><a href=\"#cursor-%E3%81%AE%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E5%8C%96\" aria-label=\"cursor のハッシュ化 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>cursor のハッシュ化</h2>\n<p>現状だとカーソルは生の日付情報を返していますが、ユーザに対して「作成日がカーソルですよ」と悟られる必要はありません。簡単に base64 でハッシュ化しておきましょう；</p>\n<div class=\"gatsby-code-title\">src/08-pagination/src/resolvers/message.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">toCursorHash</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token builtin\">string</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Buffer<span class=\"token punctuation\">.</span><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fromCursorHash</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token builtin\">string</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Buffer<span class=\"token punctuation\">.</span><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ascii'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">const</span> resolvers<span class=\"token punctuation\">:</span> IResolvers<span class=\"token operator\">&lt;</span>Message<span class=\"token punctuation\">,</span> ResolverContext<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Query<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">messages</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> cursor<span class=\"token punctuation\">,</span> limit <span class=\"token operator\">=</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> models <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> cursorOptions <span class=\"token operator\">=</span> cursor\n        <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">            where<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> createdAt<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>Op<span class=\"token punctuation\">.</span>lt<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token function\">fromCursorHash</span><span class=\"token punctuation\">(</span>cursor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> messages <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        order<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'createdAt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'DESC'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        limit<span class=\"token punctuation\">:</span> limit <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>cursorOptions<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> hasNextPage <span class=\"token operator\">=</span> messages<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> limit<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> edges <span class=\"token operator\">=</span> hasNextPage <span class=\"token operator\">?</span> messages<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> messages<span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        edges<span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">        endCursor<span class=\"token punctuation\">:</span> <span class=\"token function\">toCursorHash</span><span class=\"token punctuation\">(</span>edges<span class=\"token punctuation\">[</span>edges<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>createdAt<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span>      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-code-title\">src/08-pagination/src/schema/message.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  type PageInfo {\n    hasNextPage: Boolean!\n<span class=\"gatsby-highlight-code-line\">    endCursor: String!</span>  }\n`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>カーソルとして base64 文字列が返されるかを試してみましょう；</p>\n<div class=\"gatsby-code-title\">query</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  messages<span class=\"token punctuation\">(</span><span class=\"token attr-name\">limit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>    edges <span class=\"token punctuation\">{</span>\n      text\n      user <span class=\"token punctuation\">{</span>\n        id\n        username\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    pageInfo <span class=\"token punctuation\">{</span>\n      hasNextPage\n      endCursor\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"messages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"edges\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #5\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"suzuka light\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #4\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"suzuka light\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"pageInfo\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"hasNextPage\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token property\">\"endCursor\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VHVlIERlYyAzMSAyMDE5IDE5OjQ5OjE3IEdNVCswOTAwIChHTVQrMDk6MDAp\"</span></span>      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>成功です。この情報を使ってページネーションを実行し、さらに hasNextPage が false になるような量の limit を指定してみましょう；</p>\n<div class=\"gatsby-code-title\">query</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  messages<span class=\"token punctuation\">(</span><span class=\"token attr-name\">limit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">cursor</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"VHVlIERlYyAzMSAyMDE5IDE5OjQ5OjE3IEdNVCswOTAwIChHTVQrMDk6MDAp\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>    edges <span class=\"token punctuation\">{</span>\n      text\n      user <span class=\"token punctuation\">{</span>\n        id\n        username\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    pageInfo <span class=\"token punctuation\">{</span>\n      hasNextPage\n      endCursor\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"messages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"edges\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #3\"</span><span class=\"token punctuation\">,</span></span>          <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"suzuka light\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #2\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"suzuka light\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"message #1\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"suzuka light\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"pageInfo\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token property\">\"hasNextPage\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token property\">\"endCursor\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VHVlIERlYyAzMSAyMDE5IDE5OjQ5OjE0IEdNVCswOTAwIChHTVQrMDk6MDAp\"</span></span>      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>base64 のカーソルでもページネーションに成功し、さらに hasNextPage が false になることを確認できました、成功です！</p>\n<h1 id=\"完成品\"><a href=\"#%E5%AE%8C%E6%88%90%E5%93%81\" aria-label=\"完成品 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>完成品</h1>\n<p>実装したリポジトリはこちらです；<br>\n<a href=\"https://github.com/suzukalight/study-graphql-apollo-server/tree/master/src/08-pagination\" target=\"_blank\" rel=\"noopener\">https://github.com/suzukalight/study-graphql-apollo-server/tree/master/src/08-pagination</a></p>","tableOfContents":"<ul>\n<li><a href=\"/2019-12-31-graphql-server-pagination/#offsetlimit-%E5%BD%A2%E5%BC%8F%E3%81%AE%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%8D%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\">Offset/Limit 形式のページネーション</a></li>\n<li>\n<p><a href=\"/2019-12-31-graphql-server-pagination/#%E3%82%AB%E3%83%BC%E3%82%BD%E3%83%AB%E3%83%99%E3%83%BC%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%8D%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%EF%BC%88cursor-based%EF%BC%89\">カーソルベースページネーション（Cursor-based）</a></p>\n<ul>\n<li><a href=\"/2019-12-31-graphql-server-pagination/#edges-%E3%81%A8-pageinfo\">edges と PageInfo</a></li>\n<li><a href=\"/2019-12-31-graphql-server-pagination/#%E6%AC%A1%E3%81%AE%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%8C%E3%81%82%E3%82%8B%E3%81%8B%E3%83%95%E3%83%A9%E3%82%B0%E3%81%AE%E8%BF%BD%E5%8A%A0\">次のページがあるかフラグの追加</a></li>\n<li><a href=\"/2019-12-31-graphql-server-pagination/#cursor-%E3%81%AE%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E5%8C%96\">cursor のハッシュ化</a></li>\n</ul>\n</li>\n<li><a href=\"/2019-12-31-graphql-server-pagination/#%E5%AE%8C%E6%88%90%E5%93%81\">完成品</a></li>\n</ul>","frontmatter":{"title":"Apollo-Serverにおけるページネーション","date":"2019-12-31T00:02:00","description":null,"category":"Technology","tags":["pagination","graphql","apollo-server","express","nodejs","typescript"],"hero":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABQElEQVQoz41STU+DQBDt//8N3HohxpsmPSjxQAImPSh6qKU11BSIYq1N+VjYZffJLt2WVmocMtmdNztvHrM7wM6EEPuVEKL8P6brtA00qBNRFMH3fUynU7WnlCLPc5RlCc753iWeZRlO6wfdLmmaIkkSmKYJ27YxHA4xGo1UbFkWxuOxaua6LhzHgWEYYIwdKT0irOsas9kM3qOHl8kEYRgqTKqVjYIgUKplHMexIu9V2CUtmtnF6w+8r5Nf8zk3w+65g0JxIGX3Cbi/bQvqZmZNUma0t7FQszw7Q1G3ALmLkF8vkF3MQf0N6igDnW/Agq1aJSa9ev7qvekOYdutuFqA3C6RX76i8lZgbymqpxWIFaK4WSri6uETxI7Bv8s/FOp3SDlIUyhJVMx3uPxo5xcbAYLx85fS90j78NMzp/EPEasDxG/6Ao4AAAAASUVORK5CYII=","aspectRatio":2,"src":"/static/98b0940951ef7e653c13ceea9c765ef5/f0df8/apollo-graphql.png","srcSet":"/static/98b0940951ef7e653c13ceea9c765ef5/7b192/apollo-graphql.png 320w,\n/static/98b0940951ef7e653c13ceea9c765ef5/abde0/apollo-graphql.png 640w,\n/static/98b0940951ef7e653c13ceea9c765ef5/f0df8/apollo-graphql.png 1280w,\n/static/98b0940951ef7e653c13ceea9c765ef5/e5c90/apollo-graphql.png 1440w","sizes":"(max-width: 1280px) 100vw, 1280px"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"source":"github","slug":"/2019-12-31-graphql-server-pagination/","previous":{"head":{"title":"Sequelize+TypeScript による Apollo-Server の実装","category":"Technology","tags":["sequelize","graphql","apollo-server","express","nodejs","typescript"],"date":"2019-12-27T00:02:00","slug":"/2019-12-27-graphql-server-sequelize/","source":"github"},"siteMetadata":{"title":"suzukalight.com"}},"next":null}}}