{"componentChunkName":"component---src-components-templates-blog-post-source-github-js","path":"/2019-12-14-graphql-server-authentication/","webpackCompilationHash":"9d92a21a48f2254cf2ed","result":{"data":{"site":{"siteMetadata":{"title":"suzukalight.com","author":"suzukalight"}},"markdownRemark":{"id":"102bde55-1d1c-50b1-92c0-4a0d5feef380","excerpt":"Apollo-Server を使った GraphQL サーバのハンズオン実装シリーズ。今回は認証と認可（Authentication/Authorization）を扱います。前半は、メールアドレス・パスワードによる認証と、サインアップ処理を追加する手順です。JWT(jsonwebtoken)、bcrypt…","html":"<p>Apollo-Server を使った GraphQL サーバのハンズオン実装シリーズ。今回は<strong>認証と認可（Authentication/Authorization）</strong>を扱います。</p>\n<p>前半は、メールアドレス・パスワードによる認証と、サインアップ処理を追加する手順です。<strong>JWT(jsonwebtoken)</strong>、<strong>bcrypt</strong> による暗号化、<strong>beforeCreate などの Sequelize Hooks</strong> などを使用しています。</p>\n<p>後半は、<strong>JWT + x-token ヘッダ</strong> によるユーザ認証と、<strong>Permission-based, Role-based</strong> の認可処理を追加する手順です。ほかにリゾルバの連結を行う <strong>graphql-resolvers</strong> を紹介しています。</p>\n<p>今回も、こちらのチュートリアルをなぞって進めています；\n<a href=\"https://www.robinwieruch.de/graphql-apollo-server-tutorial\" target=\"_blank\" rel=\"noopener\">https://www.robinwieruch.de/graphql-apollo-server-tutorial</a></p>\n<p>今回実装したリポジトリはこちらです；<br>\n<a href=\"https://github.com/suzukalight/study-graphql-apollo-server/tree/master/src/06-authorization\" target=\"_blank\" rel=\"noopener\">https://github.com/suzukalight/study-graphql-apollo-server/tree/master/src/06-authorization</a></p>\n<h1 id=\"メールアドレスとパスワードによるユーザ認証\"><a href=\"#%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%A8%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AB%E3%82%88%E3%82%8B%E3%83%A6%E3%83%BC%E3%82%B6%E8%AA%8D%E8%A8%BC\" aria-label=\"メールアドレスとパスワードによるユーザ認証 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>メールアドレスとパスワードによるユーザ認証</h1>\n<h2 id=\"メールアドレスとパスワードをユーザモデルに追加\"><a href=\"#%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%A8%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%82%92%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E8%BF%BD%E5%8A%A0\" aria-label=\"メールアドレスとパスワードをユーザモデルに追加 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>メールアドレスとパスワードをユーザモデルに追加</h2>\n<p>User のモデルとスキーマに、email, password を追加します；</p>\n<div class=\"gatsby-code-title\">src/05-authentication/src/models/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Model</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> id<span class=\"token operator\">!</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">public</span> lastName<span class=\"token operator\">!</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">public</span> firstName<span class=\"token operator\">!</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">public</span> email<span class=\"token operator\">!</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">public</span> password<span class=\"token operator\">!</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span>\n\nUser<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">    email<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">type</span><span class=\"token punctuation\">:</span> DataTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      allowNull<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      validate<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        notEmpty<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        isEmail<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    password<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">type</span><span class=\"token punctuation\">:</span> DataTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      allowNull<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      validate<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        notEmpty<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        len<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">42</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-code-title\">src/05-authentication/src/schema/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  # ...\n\n  type User {\n    id: ID!\n    username: String!\n    firstName: String!\n    lastName: String!\n<span class=\"gatsby-highlight-code-line\">    email: String!</span>    messages: [Message!]\n  }\n`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>seeder にもメルパスを追加します；</p>\n<div class=\"gatsby-code-title\">src/05-authentication/src/seed.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createUsersWithMessages</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">models<span class=\"token punctuation\">:</span> Models</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    firstName<span class=\"token punctuation\">:</span> <span class=\"token string\">'masahiko'</span><span class=\"token punctuation\">,</span>\n    lastName<span class=\"token punctuation\">:</span> <span class=\"token string\">'kubara'</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    email<span class=\"token punctuation\">:</span> <span class=\"token string\">'masahiko_kubara@email.com'</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    password<span class=\"token punctuation\">:</span> <span class=\"token string\">'masahikokubara'</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> user2 <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    firstName<span class=\"token punctuation\">:</span> <span class=\"token string\">'suzuka'</span><span class=\"token punctuation\">,</span>\n    lastName<span class=\"token punctuation\">:</span> <span class=\"token string\">'light'</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    email<span class=\"token punctuation\">:</span> <span class=\"token string\">'suzukalight@email.com'</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    password<span class=\"token punctuation\">:</span> <span class=\"token string\">'suzukalight'</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>データが登録できたか、クエリを発行して確認してみます；</p>\n<div class=\"gatsby-code-title\">query</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n  users <span class=\"token punctuation\">{</span>\n    id\n    username\n    email\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"users\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"masahiko kubara\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"masahiko_kubara@email.com\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"suzuka light\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"suzukalight@email.com\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>query の戻り値として、email と password が返ってきました。成功です。</p>\n<h2 id=\"サインアップ処理の追加\"><a href=\"#%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A2%E3%83%83%E3%83%97%E5%87%A6%E7%90%86%E3%81%AE%E8%BF%BD%E5%8A%A0\" aria-label=\"サインアップ処理の追加 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>サインアップ処理の追加</h2>\n<p>実際にサインアップを行うために、<code class=\"language-text\">signUp</code> のスキーマとリゾルバを追加しましょう；</p>\n<div class=\"gatsby-code-title\">src/05-authentication/src/schema/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  # ...\n\n<span class=\"gatsby-highlight-code-line\">  extend type Mutation {</span><span class=\"gatsby-highlight-code-line\">    signUp(lastName: String!, firstName: String!, email: String!, password: String!): Token!</span><span class=\"gatsby-highlight-code-line\">  }</span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">  type Token {</span><span class=\"gatsby-highlight-code-line\">    token: String!</span><span class=\"gatsby-highlight-code-line\">  }</span>`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-code-title\">src/05-authentication/src/resolvers/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createToken</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">user<span class=\"token punctuation\">:</span> User</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token string\">'dummy'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">const</span> resolvers<span class=\"token punctuation\">:</span> IResolvers<span class=\"token operator\">&lt;</span>User<span class=\"token punctuation\">,</span> ResolverContext<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n<span class=\"gatsby-highlight-code-line\">  Mutation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token function-variable function\">signUp</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> lastName<span class=\"token punctuation\">,</span> firstName<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> models <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> lastName<span class=\"token punctuation\">,</span> firstName<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> token<span class=\"token punctuation\">:</span> <span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">User.create</code> でエンティティを生成し、サインアップ処理としています。成功したら、戻り値として認証トークンを返すようにしており、以降このトークンベースでユーザ認証を行う予定です。（トークンの実装は次節にて）</p>\n<p>実装した Mutation を実行してみます；</p>\n<div class=\"gatsby-code-title\">mutation</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  signUp<span class=\"token punctuation\">(</span><span class=\"token attr-name\">lastName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"new\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">firstName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">email</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"newuser@email.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"newuser\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    token\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"signUp\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"token\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dummy\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ユーザが追加され、トークンが返ってきました。ちなみに 4 つの引数はいずれも必須パラメータなので、いずれかが未指定の場合はエラーが帰ってきます。引数を変えてお試しいただければと思います。</p>\n<p>現時点でこのサインアップ処理には、「パスワードが暗号化されていない」という問題と、「ユーザ認証トークンの発行処理がダミーのまま」という課題があります。それぞれ実装していきましょう。</p>\n<h2 id=\"パスワードの暗号化と-sequelize-hooks\"><a href=\"#%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AE%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%A8-sequelize-hooks\" aria-label=\"パスワードの暗号化と sequelize hooks permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>パスワードの暗号化と Sequelize Hooks</h2>\n<p>パスワードの暗号化には <strong>bcrypt</strong> パッケージを利用します；</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> workspace 05-authentication <span class=\"token function\">add</span> bcrypt\n$ <span class=\"token function\">yarn</span> workspace 05-authentication <span class=\"token function\">add</span> -D @types/bcrypt</code></pre></div>\n<p>入力されたパスワードを自動的に暗号化するために、<strong>Sequelize の Hooks 関数</strong>を利用します。Hooks はエンティティに対するイベントが発生した際に自動的に実行される関数のことで、今回はユーザエンティティの生成時にフックして呼び出される関数 <strong>beforeCreate</strong> を使用しました；</p>\n<div class=\"gatsby-code-title\">src/05-authentication/src/resolvers/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> bcrypt <span class=\"token keyword\">from</span> <span class=\"token string\">'bcrypt'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">generatePasswordHash</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">user<span class=\"token punctuation\">:</span> User</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> saltRounds <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> bcrypt<span class=\"token punctuation\">.</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">,</span> saltRounds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span>\nUser<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    tableName<span class=\"token punctuation\">:</span> <span class=\"token string\">'users'</span><span class=\"token punctuation\">,</span>\n    sequelize<span class=\"token punctuation\">:</span> sequelize<span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    hooks<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token function-variable function\">beforeCreate</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">user<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        user<span class=\"token punctuation\">.</span>password <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">generatePasswordHash</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>init の第 2 引数で、hooks に関する定義ができます。ここで bcrypt を利用してパスワードを暗号化します。成功すると、DB に保存されるパスワードが自動的に暗号化されます；</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a963f2e97aaf252a8358af114eea344b/fea0e/bcrypt.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 14.222222222222221%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAk0lEQVQI1z2PWw6EIBRD2Ywx/GgUhODIY/ARMe5/O3VK4nyctJTmXhA5Ldiyx/JxMMZgHEdM0wStdfVkGIa/J+yx8+ZUbSx8/EKcZ8G6briuC/u+Y55nHMdRoU8pIeeMEAJijFXv+0YppZ55T/XewzkH0fc9mqZB13WQUtbN1loopdC2bVUOZkbe1zGnJ2+ufr96ADBaY4sUJC/xAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"bcrypt\"\n        title=\"\"\n        src=\"/static/a963f2e97aaf252a8358af114eea344b/fea0e/bcrypt.png\"\n        srcset=\"/static/a963f2e97aaf252a8358af114eea344b/01387/bcrypt.png 320w,\n/static/a963f2e97aaf252a8358af114eea344b/e49a9/bcrypt.png 640w,\n/static/a963f2e97aaf252a8358af114eea344b/fea0e/bcrypt.png 900w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n      />\n  </span>\n  </a></p>\n<h2 id=\"ユーザ認証トークンの発行\"><a href=\"#%E3%83%A6%E3%83%BC%E3%82%B6%E8%AA%8D%E8%A8%BC%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3%E3%81%AE%E7%99%BA%E8%A1%8C\" aria-label=\"ユーザ認証トークンの発行 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ユーザ認証トークンの発行</h2>\n<p>ユーザのログイン状態を確認するために、トークンベースの認証を実装していきましょう。トークンには <strong>JWT</strong> を使用し、<strong>jsonwebtoken</strong> パッケージで実装します；</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> workspace 05-authentication <span class=\"token function\">add</span> jsonwebtoken\n$ <span class=\"token function\">yarn</span> workspace 05-authentication <span class=\"token function\">add</span> -D @types/jsonwebtoken</code></pre></div>\n<p>JWT の発行には、<strong>シークレットキーと有効期限が必要です。</strong>特にシークレットキーはコード管理できない（漏洩リスク）のため、<strong>環境変数で取り扱います。</strong>その環境変数を Node 上で扱うために、<strong>dotenv</strong> パッケージを使用します；</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> workspace 05-authentication <span class=\"token function\">add</span> dotenv</code></pre></div>\n<p>.env ファイルに、シークレットキーと有効期限を記述します。この.env ファイルは gitignore してありますので、リポジトリやコードには公開されません；</p>\n<div class=\"gatsby-code-title\">src/05-authentication/.env</div>\n<div class=\"gatsby-highlight\" data-language=\"env\"><pre class=\"language-env\"><code class=\"language-env\">JWT_SECRET=&quot;your_jwt_secret_phrase&quot;\nJWT_EXPIRES_IN=&quot;30m&quot;</code></pre></div>\n<p>index.ts で、環境変数として取り込み、context に流し込みましょう；</p>\n<div class=\"gatsby-code-title\">src/05-authentication/src/resolvers/typings.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ResolverContext</span> <span class=\"token punctuation\">{</span>\n  me<span class=\"token punctuation\">:</span> User<span class=\"token punctuation\">;</span>\n  models<span class=\"token punctuation\">:</span> Models<span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  jwt<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    secret<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    expiresIn<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">src/05-authentication/src/index.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> dotenv <span class=\"token keyword\">from</span> <span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"gatsby-highlight-code-line\">dotenv<span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">context</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    models<span class=\"token punctuation\">,</span>\n    me<span class=\"token punctuation\">:</span> <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">.</span><span class=\"token function\">findByPk</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    jwt<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> secret<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">JWT_SECRET</span><span class=\"token punctuation\">,</span> expiresIn<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">JWT_EXPIRES_IN</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>シークレットキーと有効期限の情報をもとに、JWT トークンを発行します；</p>\n<div class=\"gatsby-code-title\">src/05-authentication/src/resolvers/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> jwt <span class=\"token keyword\">from</span> <span class=\"token string\">'jsonwebtoken'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createToken</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">user<span class=\"token punctuation\">:</span> User<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> expiresIn<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> email <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> user<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> expiresIn <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">const</span> resolvers<span class=\"token punctuation\">:</span> IResolvers<span class=\"token operator\">&lt;</span>User<span class=\"token punctuation\">,</span> ResolverContext<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Mutation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token function-variable function\">signUp</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> lastName<span class=\"token punctuation\">,</span> firstName<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> models<span class=\"token punctuation\">,</span> jwt <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> lastName<span class=\"token punctuation\">,</span> firstName<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> token<span class=\"token punctuation\">:</span> <span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> jwt<span class=\"token punctuation\">.</span>secret<span class=\"token punctuation\">,</span> jwt<span class=\"token punctuation\">.</span>expiresIn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">jwt.sign</code> を使用して、id と email の情報を含んだ JWT トークンを生成しています。この情報を signUp リゾルバの戻り値とし、認証情報としてクライアント側の localstorage などで管理してもらうこととします。</p>\n<h2 id=\"サインイン処理\"><a href=\"#%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E5%87%A6%E7%90%86\" aria-label=\"サインイン処理 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>サインイン処理</h2>\n<p>サインアップ処理で、ユーザ認証トークンの発行ができるようになりましたので、これを用いて、サインイン処理でのトークン発行も実装します。</p>\n<p><strong>User スキーマ</strong><br>\nmutation として signIn 関数を追加します；</p>\n<div class=\"gatsby-code-title\">src/05-authentication/src/schema/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  # ...\n\n  extend type Mutation {\n    signUp(lastName: String!, firstName: String!, email: String!, password: String!): Token!\n<span class=\"gatsby-highlight-code-line\">    signIn(email: String!, password: String!): Token!</span>  }\n`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>User モデル</strong><br>\nサインインするユーザを検索するためのクエリ関数（findByEmail）と、入力したパスワードの有効性を確認する関数（validatePassword）を追加していきます；</p>\n<div class=\"gatsby-code-title\">src/05-authentication/src/models/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Model</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token function-variable function\">findByEmail</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">email<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>User <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">public</span> validatePassword<span class=\"token operator\">!</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">password<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">boolean</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\">User<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">findByEmail</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">email<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> User<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> where<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> email <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\"><span class=\"token class-name\">User</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">validatePassword</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">password<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> bcrypt<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span></code></pre></div>\n<p><code class=\"language-text\">findByEmail</code> は <code class=\"language-text\">models.User</code> 経由で実行される関数のため、static 関数で定義します。実装としては findOne で email を検索するシンプルなものです。</p>\n<p><code class=\"language-text\">validatePassword</code> は、取得した user エンティティのパスワードと、ユーザが入力したパスワードとを比較する関数のため、インスタンス関数として定義しています。実装としては <strong>bcrypt.compare</strong> を使って、暗号化された DB データと、それと同じロジックで暗号化した入力データとが一致するかを比較しています。</p>\n<p><strong>User リゾルバ</strong><br>\nUser モデルの関数と、JWT 発行関数とを利用して、サインイン処理を完成させます；</p>\n<div class=\"gatsby-code-title\">src/05-authentication/src/resolvers/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> IResolvers<span class=\"token punctuation\">,</span> UserInputError<span class=\"token punctuation\">,</span> AuthenticationError <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'apollo-server-express'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">const</span> resolvers<span class=\"token punctuation\">:</span> IResolvers<span class=\"token operator\">&lt;</span>User<span class=\"token punctuation\">,</span> ResolverContext<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n  Mutation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token function-variable function\">signIn</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> email<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> models<span class=\"token punctuation\">,</span> jwt <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">.</span><span class=\"token function\">findByEmail</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>user<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserInputError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'No user found with this login credentials.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> isValid <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> user<span class=\"token punctuation\">.</span><span class=\"token function\">validatePassword</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isValid<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthenticationError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid password.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> token<span class=\"token punctuation\">:</span> <span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> jwt<span class=\"token punctuation\">.</span>secret<span class=\"token punctuation\">,</span> jwt<span class=\"token punctuation\">.</span>expiresIn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ol>\n<li>入力された email, password をもとに、<strong>findByEmail</strong> でユーザを検索</li>\n<li>そのユーザのパスワードを <strong>validatePassword</strong> で検証</li>\n<li>新しいユーザ認証トークンを <strong>createToken</strong> で発行して、戻り値とする</li>\n</ol>\n<p>では signIn Mutation を実行してみます；</p>\n<div class=\"gatsby-code-title\">mutation</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  signIn<span class=\"token punctuation\">(</span><span class=\"token attr-name\">email</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"suzukalight@email.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"suzukalight\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    token\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"signIn\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"token\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwiZW1haWwiOiJzdXp1a2FsaWdodEBlbWFpbC5jb20iLCJpYXQiOjE1NzYzMDc1MTUsImV4cCI6MTU3NjMwOTMxNX0.F_a_w7kPXZBpho4r8EFbuU1CvmJU-qYA2ISQ92cRMQw\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>成功です！</p>\n<p>ここで email, password をそれぞれ変えてみると、サーバからそれぞれ適切なエラーメッセージが返ってくると思いますので、お試しください。</p>\n<h1 id=\"認可\"><a href=\"#%E8%AA%8D%E5%8F%AF\" aria-label=\"認可 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>認可</h1>\n<h2 id=\"ユーザ認証トークンから-me-情報を取得\"><a href=\"#%E3%83%A6%E3%83%BC%E3%82%B6%E8%AA%8D%E8%A8%BC%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3%E3%81%8B%E3%82%89-me-%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97\" aria-label=\"ユーザ認証トークンから me 情報を取得 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ユーザ認証トークンから me 情報を取得</h2>\n<p>サインイン処理によって発行された JWT トークンには、id と email が載っています。<strong>この情報をクライアントで保管し、サーバアクセス時に送信してもらう</strong>ことで、クライアントがどのユーザでサインインしているかを判定します。</p>\n<div class=\"gatsby-code-title\">src/06-authorization/src/index.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ApolloServer<span class=\"token punctuation\">,</span> AuthenticationError <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'apollo-server-express'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getMe</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">:</span> Request</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-token'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">return</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">JWT_SECRET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthenticationError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Your session expired. Sign in again.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token function-variable function\">context</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> req <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> me <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getMe</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      models<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      me<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      jwt<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> secret<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">JWT_SECRET</span><span class=\"token punctuation\">,</span> expiresIn<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">JWT_EXPIRES_IN</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre></div>\n<ul>\n<li>クライアントは、リクエストヘッダの <code class=\"language-text\">x-token</code> フィールドに、JWT を詰めてリクエストを行う仕様とします</li>\n<li>サーバ側では、この x-token フィールドを、context の <code class=\"language-text\">req.headers</code> 引数経由で取得します</li>\n<li>取り出した  <code class=\"language-text\">jwt.verify</code> でトークンを検証します。成功すれば、JWT に詰めていた id, email の情報を取り出すことができ、これを me の情報として今後扱っていきます</li>\n</ul>\n<h2 id=\"message-リゾルバに認可処理を追加-graphql-resolvers\"><a href=\"#message-%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%81%AB%E8%AA%8D%E5%8F%AF%E5%87%A6%E7%90%86%E3%82%92%E8%BF%BD%E5%8A%A0-graphql-resolvers\" aria-label=\"message リゾルバに認可処理を追加 graphql resolvers permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Message リゾルバに認可処理を追加 (graphql-resolvers)</h2>\n<p>リゾルバに認可処理を追加していきますが、基本的に<strong>「ログインユーザに対する認証認可」は非常に多くのシチュエーションで登場するため、その処理を切り出しておきたくなると思います。</strong></p>\n<p>たとえば createMessage では、まず「ログインユーザ認可」→「メッセージ生成処理」という解決をしたいですし、deleteMessage ではさらに「メッセージのオーナー、あるいは管理者であるかの認可」も付け加えたいと感じるのではないでしょうか？</p>\n<p>そうやって<strong>切り出した処理をつなぎ合わせて、新しいリゾルバにできる仕組み</strong>があれば便利なのですが、それを行ってくれるコンパニオンツールとして、<strong><a href=\"https://github.com/lucasconstantino/graphql-resolvers\" target=\"_blank\" rel=\"noopener\">graphql-resolvers</a></strong> があります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> workspace 06-authorization <span class=\"token function\">add</span> graphql-resolvers\n$ <span class=\"token function\">yarn</span> workspace 06-authorization <span class=\"token function\">add</span> -D @types/graphql-resolvers</code></pre></div>\n<p>ログインユーザ情報が存在するかを確認する、<code class=\"language-text\">isAuthenticated</code>関数を切り出してみましょう；</p>\n<div class=\"gatsby-code-title\">src/06-authorization/src/resolvers/authorization.ts</div>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> skip <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'graphql-resolvers'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ForbiddenError <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'apollo-server-express'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ResolverContext <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./typings'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isAuthenticated</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> me <span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span> ResolverContext</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  me <span class=\"token operator\">?</span> skip <span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForbiddenError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Not authenticated as user.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>me 情報の有無で、ログインしているかどうかを確認しています。このリゾルバは skip が評価されると成功したことになり、次のリゾルバに処理が移ります。</p>\n<p>これを既存の createMessage リゾルバに連結してみます；</p>\n<div class=\"gatsby-code-title\">src/06-authorization/src/resolvers/message.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> combineResolvers <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'graphql-resolvers'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> isAuthenticated <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./authorization'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">const</span> resolvers<span class=\"token punctuation\">:</span> IResolvers<span class=\"token operator\">&lt;</span>User<span class=\"token punctuation\">,</span> ResolverContext<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Mutation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    createMessage<span class=\"token punctuation\">:</span> <span class=\"token function\">combineResolvers</span><span class=\"token punctuation\">(</span>isAuthenticated<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> text <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> me<span class=\"token punctuation\">,</span> models <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span></span><span class=\"gatsby-highlight-code-line\">      models<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        text<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        userId<span class=\"token punctuation\">:</span> me<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">combineResolvers</code> 関数に、任意の個数のリゾルバ関数を引き渡すと、それらを順次実行してくれます。</p>\n<p>認可処理を動作確認してみましょう。まずは有効期限切れになったトークンを x-token に指定して実行してみます；</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ccf5f0979d754093563b52588bc5e44c/3b243/token-expired.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1024px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 42.1875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABYElEQVQoz3WRS2+CUBSEWbaJPETkglYF1PrgqVKpoiRtjEm33fcvdNtlf/r03Ae66mIy95CcL3MGzZ5t0Z2XJPJpgW5UwG5Fsz5JEBRnXD6/0F9VcNcV+eu/0rphDmu5I20ImMEJM/SDHG5QwCHog79AWl/x/fMLLz7gieAsORH4QDoqV+/4CM0KUpizDBbBDEpj0Cw9EW7S3BmtxRVuUsPNG7DtO1jRwN2chBj3vFZASmSGKaxFATMiuIIIV28OdpYVWMaBJ/jVB/z9Bd4Lwbk2KjEHdqNcAvhim26S3r61QN4fi2vRE8vf4JVXeDxlcrypT1BNppBp+PlWmIrZmMRKCfRxjN5iT2dSkkKex3bnu7Yn4RyqdYbPMEYL6CRzvEIvJNhoiUdvKuXPyCPY8x0tNXKxhZZn2R2vIlE/xRg8wx4s4QxWwrl69HaGK+F81v35HbhXvfFkZSPFO0zlyX/oD+VH4uXc5QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"token expired\"\n        title=\"\"\n        src=\"/static/ccf5f0979d754093563b52588bc5e44c/3b243/token-expired.png\"\n        srcset=\"/static/ccf5f0979d754093563b52588bc5e44c/01387/token-expired.png 320w,\n/static/ccf5f0979d754093563b52588bc5e44c/e49a9/token-expired.png 640w,\n/static/ccf5f0979d754093563b52588bc5e44c/3b243/token-expired.png 1024w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n      />\n  </span>\n  </a></p>\n<p><code class=\"language-text\">Your session expired.</code> となって、正常に失敗しました。つづけて signIn を実行して新しいトークンを取得し、その結果を x-token に指定しなおしてみます；</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/140e95a98c7ae7567c29c2f44dcdffb9/3b243/create-message-succeeded.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1024px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 42.1875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABR0lEQVQoz22SS2+CQBRGWdpUZwDFQS2KoLxF0NZnjUnrsr+g6y667rY//utlEMXUxcllhszJmYCiTxbQvBdoU5puBt2p4eZoDhO4yyM+Pr9ghGuIaC2nEW5gRHW2EkUdp1D9nMhImKJDa8OeExk6JG30fSTbE75/fmHGG1j5ESJ/g0iP6Ma7fyiqPQOfkNRJwaiG2cQoQWtUTk7vm1YERrVFQTc7wVy+Q2Sv9Ewku7Iu3l0L+XgGNcjAScrPEj4qYfRciDvBmgpIODvAXJwg5gcS7m+kslBz5lLA7OvhqqyiFK7o4F4eMu5ctRRSYVEkr11MKtWoslizYXyhNYzQ9lcQlfD8AepU+0pz4IFZPlpPPrgVQB+ThOaD6V5oCAe69ywLq8P3C+nKj/0pWM8Dl/jQewG0PomJ9iCUaLRv0K9Vr7sVbi/zDxrj48jbHzN4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"create message succeeded\"\n        title=\"\"\n        src=\"/static/140e95a98c7ae7567c29c2f44dcdffb9/3b243/create-message-succeeded.png\"\n        srcset=\"/static/140e95a98c7ae7567c29c2f44dcdffb9/01387/create-message-succeeded.png 320w,\n/static/140e95a98c7ae7567c29c2f44dcdffb9/e49a9/create-message-succeeded.png 640w,\n/static/140e95a98c7ae7567c29c2f44dcdffb9/3b243/create-message-succeeded.png 1024w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n      />\n  </span>\n  </a></p>\n<p>今度は成功しました！</p>\n<h2 id=\"permission-based-authorization\"><a href=\"#permission-based-authorization\" aria-label=\"permission based authorization permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Permission-based Authorization</h2>\n<p>この仕組みを使って deleteMessage も作成していきます。メッセージの削除に対する認可として「そのメッセージのオーナーかどうか」を条件としてみます。こういった<strong>「誰に対して何を認可する」という認可手法を、Permission-based な認可</strong>と呼んだりします。</p>\n<p>authorization リゾルバ集に、メッセージのオーナーであるかどうかで認可を行う、<code class=\"language-text\">isMessageOwner</code> を追加します；</p>\n<div class=\"gatsby-code-title\">src/06-authorization/src/resolvers/authorization.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> Message <span class=\"token keyword\">from</span> <span class=\"token string\">'../models/message'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token comment\">// ...</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isMessageOwner</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token parameter\">parent<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span> Message<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">{</span> models<span class=\"token punctuation\">,</span> me <span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span> ResolverContext<span class=\"token punctuation\">,</span></span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">.</span><span class=\"token function\">findByPk</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> raw<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>message <span class=\"token operator\">||</span> message<span class=\"token punctuation\">.</span>userId <span class=\"token operator\">!==</span> me<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForbiddenError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Not authenticated as owner.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> skip<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span></code></pre></div>\n<p>これを deleteMessage リゾルバで使用してみましょう；</p>\n<div class=\"gatsby-code-title\">src/06-authorization/src/resolvers/message.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> isAuthenticated<span class=\"token punctuation\">,</span> isMessageOwner <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./authorization'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">const</span> resolvers<span class=\"token punctuation\">:</span> IResolvers<span class=\"token operator\">&lt;</span>User<span class=\"token punctuation\">,</span> ResolverContext<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Mutation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n\n<span class=\"gatsby-highlight-code-line\">    deleteMessage<span class=\"token punctuation\">:</span> <span class=\"token function\">combineResolvers</span><span class=\"token punctuation\">(</span></span><span class=\"gatsby-highlight-code-line\">      isAuthenticated<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      isMessageOwner<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> models <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span></span><span class=\"gatsby-highlight-code-line\">        models<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">          where<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>まず <code class=\"language-text\">isAuthenticated</code> でログインしているかどうかを判定し、次に <code class=\"language-text\">isMessageOwner</code> でそのユーザが当該メッセージのオーナーであるかを判定しています。いずれも満たす場合にだけ、はじめて <code class=\"language-text\">Message.destroy</code> が行われる処理へ到達する、というリゾルバにすることができました。</p>\n<p>このように、<strong>combineResolvers を使うことで、シンプルかつ解りやすい認可実装が実現できています。</strong></p>\n<h2 id=\"role-based-authorization-rbac\"><a href=\"#role-based-authorization-rbac\" aria-label=\"role based authorization rbac permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Role-based Authorization (RBAC)</h2>\n<p>これまで Permission-based な認可についてご紹介しました。このようなユーザごとに認可を割り付ける手法はシンプルですが、<strong>ユーザと認可が増えると爆発的に設定個数が増え、管理が難しくなる側面もあります。</strong></p>\n<p>こうした問題を解決する方法として、ユーザに認可をつけるのではなく、<strong>ユーザが持つ役割に対して認可を付ける方法があります。</strong>具体的には「Admin 権限の人はユーザの削除ができる」や「Editor 権限の人は記事の編集だけはできる」などの表現になります。</p>\n<p>管理者は役割に対して認可を与え、その役割をユーザに割り付けることで、管理すべき認可を大きくグルーピングできることができるようになります。<strong>実質的な管理工数はユーザ数にのみ依存</strong>することになり、現実的な工数感に収めることができるようになります。</p>\n<p>前置きはここまでで、実装に移ってまいりましょう。まずは User エンティティに Role を追加します；</p>\n<div class=\"gatsby-code-title\">src/06-authorization/src/models/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> Role <span class=\"token operator\">=</span> <span class=\"token string\">'member'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'admin'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Model</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">public</span> role<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> Role<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span>\nUser<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  role<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">type</span><span class=\"token punctuation\">:</span> DataTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre></div>\n<p>seeder にはユーザごとに権限を分けて設定してみます；</p>\n<div class=\"gatsby-code-title\">src/06-authorization/src/seed.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createUsersWithMessages</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">models<span class=\"token punctuation\">:</span> Models</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\">    role<span class=\"token punctuation\">:</span> <span class=\"token string\">'member'</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> user2 <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> models<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\">    role<span class=\"token punctuation\">:</span> <span class=\"token string\">'admin'</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>スキーマにも role を追加するとともに、ユーザを削除できる mutation である deleteUser を追加します；</p>\n<div class=\"gatsby-code-title\">src/06-authorization/src/schema/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  extend type Mutation {\n    # ...\n<span class=\"gatsby-highlight-code-line\">    deleteUser(id: ID!): Boolean</span>  }\n\n  type User {\n    # ...\n<span class=\"gatsby-highlight-code-line\">    role: String</span>  }\n`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Role-based な認可のリゾルバとして、ログインユーザが管理者権限かを調べる isAdmin を追加します。me はログインしていない場合には null になりますので、<strong>Optional Chaining <code class=\"language-text\">me?.role</code> で null チェックします</strong>；</p>\n<div class=\"gatsby-code-title\">src/06-authorization/src/resolvers/authorization.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isAdmin</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> me <span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span> ResolverContext</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  me<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>role <span class=\"token operator\">===</span> <span class=\"token string\">'admin'</span> <span class=\"token operator\">?</span> skip <span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ForbiddenError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Not authorized as admin'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>各素材を使って deleteUser リゾルバを記述しましょう；</p>\n<div class=\"gatsby-code-title\">src/06-authorization/src/resolvers/user.ts</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> combineResolvers <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'graphql-resolvers'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> isAdmin <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./authorization'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createToken</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">user<span class=\"token punctuation\">:</span> User<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> expiresIn<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">,</span> role <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> user<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">,</span> role <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> expiresIn <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> resolvers<span class=\"token punctuation\">:</span> IResolvers<span class=\"token operator\">&lt;</span>User<span class=\"token punctuation\">,</span> ResolverContext<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Mutation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\">    deleteUser<span class=\"token punctuation\">:</span> <span class=\"token function\">combineResolvers</span><span class=\"token punctuation\">(</span>isAdmin<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> models <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span></span><span class=\"gatsby-highlight-code-line\">      models<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> where<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong><code class=\"language-text\">createToken</code> で JWT へ role を追加しています。</strong>context.me は getMe の情報を参照し、getMe は JWT を参照しますので、この role が JWT に設定されていないと、各種の role-based な処理はすべて失敗してしまいます。忘れずに追加しておきましょう。</p>\n<h2 id=\"rbac-の-mutation-を実行\"><a href=\"#rbac-%E3%81%AE-mutation-%E3%82%92%E5%AE%9F%E8%A1%8C\" aria-label=\"rbac の mutation を実行 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RBAC の mutation を実行</h2>\n<p>では実際に deleteUser を実行してみます。先に signUp でメンバーを 1 人追加しておき、role=admin のメンバーでサインインして、そのメンバー（id:3）を削除してみましょう；</p>\n<div class=\"gatsby-code-title\">mutation</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  signUp<span class=\"token punctuation\">(</span><span class=\"token attr-name\">lastName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"new\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">firstName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">email</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"newuser@email.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"newuser\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    token\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  signIn<span class=\"token punctuation\">(</span><span class=\"token attr-name\">email</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"suzukalight@email.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"suzukalight\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    token\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  deleteUser<span class=\"token punctuation\">(</span><span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"deleteUser\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>成功しました。role=admin の場合は、deleteUser ができています。</p>\n<p>次に、role=member のメンバーでサインインした場合はどうでしょうか？</p>\n<div class=\"gatsby-code-title\">mutation</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  signUp<span class=\"token punctuation\">(</span><span class=\"token attr-name\">lastName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"new\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">firstName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">email</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"newuser@email.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"newuser\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    token\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  signIn<span class=\"token punctuation\">(</span><span class=\"token attr-name\">email</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"masahiko_kubara@email.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"masahikokubara\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    token\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  deleteUser<span class=\"token punctuation\">(</span><span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"4\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title\">response</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"errors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Not authorized as admin\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>正常に失敗しました。同じ mutation でも、role によって実行の可否が振り分けできるようになり、グッと本格的なサービスっぽくなってきましたね！</p>\n<h1 id=\"完成品\"><a href=\"#%E5%AE%8C%E6%88%90%E5%93%81\" aria-label=\"完成品 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>完成品</h1>\n<p>実装したリポジトリはこちらです；<br>\n<a href=\"https://github.com/suzukalight/study-graphql-apollo-server/tree/master/src/06-authorization\" target=\"_blank\" rel=\"noopener\">https://github.com/suzukalight/study-graphql-apollo-server/tree/master/src/06-authorization</a></p>","tableOfContents":"<ul>\n<li>\n<p><a href=\"/2019-12-14-graphql-server-authentication/#%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%A8%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AB%E3%82%88%E3%82%8B%E3%83%A6%E3%83%BC%E3%82%B6%E8%AA%8D%E8%A8%BC\">メールアドレスとパスワードによるユーザ認証</a></p>\n<ul>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%A8%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%82%92%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E8%BF%BD%E5%8A%A0\">メールアドレスとパスワードをユーザモデルに追加</a></li>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A2%E3%83%83%E3%83%97%E5%87%A6%E7%90%86%E3%81%AE%E8%BF%BD%E5%8A%A0\">サインアップ処理の追加</a></li>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%AE%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%A8-sequelize-hooks\">パスワードの暗号化と Sequelize Hooks</a></li>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#%E3%83%A6%E3%83%BC%E3%82%B6%E8%AA%8D%E8%A8%BC%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3%E3%81%AE%E7%99%BA%E8%A1%8C\">ユーザ認証トークンの発行</a></li>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E5%87%A6%E7%90%86\">サインイン処理</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/2019-12-14-graphql-server-authentication/#%E8%AA%8D%E5%8F%AF\">認可</a></p>\n<ul>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#%E3%83%A6%E3%83%BC%E3%82%B6%E8%AA%8D%E8%A8%BC%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3%E3%81%8B%E3%82%89-me-%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97\">ユーザ認証トークンから me 情報を取得</a></li>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#message-%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%81%AB%E8%AA%8D%E5%8F%AF%E5%87%A6%E7%90%86%E3%82%92%E8%BF%BD%E5%8A%A0-graphql-resolvers\">Message リゾルバに認可処理を追加 (graphql-resolvers)</a></li>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#permission-based-authorization\">Permission-based Authorization</a></li>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#role-based-authorization-rbac\">Role-based Authorization (RBAC)</a></li>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#rbac-%E3%81%AE-mutation-%E3%82%92%E5%AE%9F%E8%A1%8C\">RBAC の mutation を実行</a></li>\n</ul>\n</li>\n<li><a href=\"/2019-12-14-graphql-server-authentication/#%E5%AE%8C%E6%88%90%E5%93%81\">完成品</a></li>\n</ul>","frontmatter":{"title":"Apollo-Serverにおける認証と認可 (Authentication/Authorization)","date":"2019-12-14T00:02:00","description":null,"category":"Technology","tags":["graphql","apollo-server","express","nodejs","typescript","jwt","bcrypt"],"hero":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABQElEQVQoz41STU+DQBDt//8N3HohxpsmPSjxQAImPSh6qKU11BSIYq1N+VjYZffJLt2WVmocMtmdNztvHrM7wM6EEPuVEKL8P6brtA00qBNRFMH3fUynU7WnlCLPc5RlCc753iWeZRlO6wfdLmmaIkkSmKYJ27YxHA4xGo1UbFkWxuOxaua6LhzHgWEYYIwdKT0irOsas9kM3qOHl8kEYRgqTKqVjYIgUKplHMexIu9V2CUtmtnF6w+8r5Nf8zk3w+65g0JxIGX3Cbi/bQvqZmZNUma0t7FQszw7Q1G3ALmLkF8vkF3MQf0N6igDnW/Agq1aJSa9ev7qvekOYdutuFqA3C6RX76i8lZgbymqpxWIFaK4WSri6uETxI7Bv8s/FOp3SDlIUyhJVMx3uPxo5xcbAYLx85fS90j78NMzp/EPEasDxG/6Ao4AAAAASUVORK5CYII=","aspectRatio":2,"src":"/static/98b0940951ef7e653c13ceea9c765ef5/f0df8/apollo-graphql.png","srcSet":"/static/98b0940951ef7e653c13ceea9c765ef5/7b192/apollo-graphql.png 320w,\n/static/98b0940951ef7e653c13ceea9c765ef5/abde0/apollo-graphql.png 640w,\n/static/98b0940951ef7e653c13ceea9c765ef5/f0df8/apollo-graphql.png 1280w,\n/static/98b0940951ef7e653c13ceea9c765ef5/e5c90/apollo-graphql.png 1440w","sizes":"(max-width: 1280px) 100vw, 1280px"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"source":"github","slug":"/2019-12-14-graphql-server-authentication/","previous":{"head":{"title":"GraphQL Apollo-Server ハンズオン","category":"Technology","tags":["graphql","apollo-server","express","nodejs","typescript","ts-node-dev"],"date":"2019-12-08T00:02:00","slug":"/2019-12-08-graphql-server/","source":"github"},"siteMetadata":{"title":"suzukalight.com"}},"next":null}}}