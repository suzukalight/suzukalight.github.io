{"componentChunkName":"component---src-components-templates-blog-post-source-github-js","path":"/2019-09-03-monorepo-jest-storyshots/","webpackCompilationHash":"607bd425f2945b82a42e","result":{"data":{"site":{"siteMetadata":{"title":"suzukalight.com","author":"suzukalight"}},"markdownRemark":{"id":"8f2a6f39-8f57-5b3e-ac3a-a615895bb76c","excerpt":"monorepo 環境で、create-react-app w/ TypeScript したパッケージに対して、Jest のテストと、Storyshots による Storybook ベースのスナップショットテスティングを導入する例です。まえがき完成品実装内容をプルリクエストにしたものを、GitHub…","html":"<p>monorepo 環境で、create-react-app w/ TypeScript したパッケージに対して、Jest のテストと、Storyshots による Storybook ベースのスナップショットテスティングを導入する例です。</p>\n<h1 id=\"まえがき\"><a href=\"#%E3%81%BE%E3%81%88%E3%81%8C%E3%81%8D\" aria-label=\"まえがき permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まえがき</h1>\n<h2 id=\"完成品\"><a href=\"#%E5%AE%8C%E6%88%90%E5%93%81\" aria-label=\"完成品 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>完成品</h2>\n<p>実装内容をプルリクエストにしたものを、GitHub 上に公開していますので、併せてご参照ください。</p>\n<ul>\n<li><a href=\"https://github.com/suzukalight/monorepo-react-prisma2/pull/2\" target=\"_blank\" rel=\"noopener\">https://github.com/suzukalight/monorepo-react-prisma2/pull/2</a></li>\n<li><a href=\"https://github.com/suzukalight/monorepo-react-prisma2/pull/3\" target=\"_blank\" rel=\"noopener\">https://github.com/suzukalight/monorepo-react-prisma2/pull/3</a></li>\n</ul>\n<h2 id=\"動作環境\"><a href=\"#%E5%8B%95%E4%BD%9C%E7%92%B0%E5%A2%83\" aria-label=\"動作環境 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>動作環境</h2>\n<ul>\n<li>Mac</li>\n<li>Node.js v10.16.0 / npm v6.9.0 / yarn v1.16.0</li>\n<li>create-react-app (react-script v3.1.1)</li>\n<li>TypeScript v3.5.3</li>\n<li>Storybook v5.1</li>\n<li>Jest v24.9</li>\n<li>Babel v7</li>\n</ul>\n<h1 id=\"jest-のセットアップ\"><a href=\"#jest-%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97\" aria-label=\"jest のセットアップ permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Jest のセットアップ</h1>\n<h2 id=\"yarn-install\"><a href=\"#yarn-install\" aria-label=\"yarn install permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>yarn install</h2>\n<ul>\n<li>Jest のインストール</li>\n<li>Babel および presets のインストール（react, typescript）</li>\n<li>型情報もインストール</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> <span class=\"token function\">add</span> -DW @babel/core @babel/preset-env @babel/preset-react @babel/preset-typescript babel-jest babel-plugin-require-context-hook jest react-test-renderer @types/jest</code></pre></div>\n<h2 id=\"global-config\"><a href=\"#global-config\" aria-label=\"global config permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>global config</h2>\n<h3 id=\"babelconfigjs\"><a href=\"#babelconfigjs\" aria-label=\"babelconfigjs permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/babel.config.js</h3>\n<ul>\n<li><strong>presets</strong>: React(JSX)と TypeScript を変換するように指定します</li>\n<li><strong>babelrcRoots</strong>: Jest で実行する Babel に対して、monorepo 構成であることを伝えます</li>\n</ul>\n<div class=\"gatsby-code-title\">/babel.config.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  presets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">'@babel/preset-env'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> targets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> node<span class=\"token punctuation\">:</span> <span class=\"token string\">'current'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> modules<span class=\"token punctuation\">:</span> <span class=\"token string\">'commonjs'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'@babel/preset-react'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'@babel/preset-typescript'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  babelrcRoots<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'src/*'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"jestconfigjs\"><a href=\"#jestconfigjs\" aria-label=\"jestconfigjs permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/jest.config.js</h3>\n<p><strong><a href=\"https://jestjs.io/docs/ja/configuration#projects-array-string-projectconfig\" target=\"_blank\" rel=\"noopener\">projects オプション</a></strong>を指定して、Jest が複数のプロジェクトを独立して扱えるようにします。<code class=\"language-text\">&lt;rootDir&gt;/[packages-dir]/*</code> を指定すると、packages-dir 配下のすべてのプロジェクトがテスト対象となり、Jest コマンドによって並行してテストされるようになります；</p>\n<div class=\"gatsby-code-title\">/jest.config.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  projects<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'&lt;rootDir>/src/*'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1 id=\"client-プロジェクトのセットアップ\"><a href=\"#client-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97\" aria-label=\"client プロジェクトのセットアップ permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>client プロジェクトのセットアップ</h1>\n<p>create-react-app 環境には、デフォルトで src/App.test.tsx がありますので、まずはこのテストが通るように環境を整えます。</p>\n<h2 id=\"srcclientjestconfigjs\"><a href=\"#srcclientjestconfigjs\" aria-label=\"srcclientjestconfigjs permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/src/client/jest.config.js</h2>\n<ul>\n<li><strong>displayName</strong>: テスト実行中に、ラベルとして console に表示してくれます</li>\n<li><strong>moduleFileExtensions</strong>: テスト対象の拡張子を指定します</li>\n<li><strong>transform</strong>: Babel などの変換プロセスを指定します。JS ファイルを指定して、より細かい変換動作を指定できます</li>\n<li><strong>testMatch</strong>: テスト対象のファイル名を正規表現で指定します</li>\n<li><strong>moduleNameMapper</strong>: import などで指定したファイルが、テストにおいて邪魔になる場合、それを別のモジュールに置き換えることができる設定です。assets と styles を、それぞれダミーデータに置き換えさせています</li>\n</ul>\n<div class=\"gatsby-code-title\">/src/client/jest.config.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  name<span class=\"token punctuation\">:</span> <span class=\"token string\">'client'</span><span class=\"token punctuation\">,</span>\n  displayName<span class=\"token punctuation\">:</span> <span class=\"token string\">'client'</span><span class=\"token punctuation\">,</span>\n  verbose<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  moduleFileExtensions<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'js'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'json'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jsx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ts'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'tsx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'node'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  transform<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'^.+\\\\.(js|jsx|ts|tsx)$'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'&lt;rootDir>/.jest/transform.js'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  testMatch<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'&lt;rootDir>/**/?(*.)(spec|test).(ts|js)?(x)'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  moduleNameMapper<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'\\\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga)$'</span><span class=\"token punctuation\">:</span>\n      <span class=\"token string\">'&lt;rootDir>/.jest/__mocks__/file.js'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'\\\\.(styl|css|less|scss)$'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'&lt;rootDir>/.jest/__mocks__/style.js'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"srcclientjesttransformjs\"><a href=\"#srcclientjesttransformjs\" aria-label=\"srcclientjesttransformjs permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/src/client/.jest/transform.js</h2>\n<p><strong>babel-jest</strong> で JS ファイルを変換します。この変換において使用する Babel オプションをここで指定できます；</p>\n<div class=\"gatsby-code-title\">/src/client/.jest/transform.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'babel-jest'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createTransformer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  presets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">'@babel/preset-env'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> targets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> node<span class=\"token punctuation\">:</span> <span class=\"token string\">'current'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> modules<span class=\"token punctuation\">:</span> <span class=\"token string\">'commonjs'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'@babel/preset-react'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'@babel/preset-typescript'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'require-context-hook'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'@babel/plugin-transform-modules-commonjs'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"mocks\"><a href=\"#mocks\" aria-label=\"mocks permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mocks</h2>\n<p><strong><a href=\"https://jestjs.io/docs/ja/webpack#%E9%9D%99%E7%9A%84%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E7%AE%A1%E7%90%86\" target=\"_blank\" rel=\"noopener\">Jest の例に載っているモックファイル</a></strong>をそのまま利用します。</p>\n<div class=\"gatsby-code-title\">/src/client/.jest/__mocks__/file.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token string\">'test-file-stub'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-code-title\">/src/client/.jest/__mocks__/style.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"テスト実行\"><a href=\"#%E3%83%86%E3%82%B9%E3%83%88%E5%AE%9F%E8%A1%8C\" aria-label=\"テスト実行 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>テスト実行</h2>\n<p>以上で Jest 実行環境が整いましたので、package.json にテストコマンドを追加して、実行してみます；</p>\n<div class=\"gatsby-code-title\">package.json</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NODE_ENV=test jest\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> <span class=\"token function\">test</span>\n\n<span class=\"token function\">yarn</span> run v1.16.0\n$ NODE_ENV<span class=\"token operator\">=</span>test jest\n PASS   client  src/client/src/App.test.tsx\n  ✓ renders without crashing <span class=\"token punctuation\">(</span>20ms<span class=\"token punctuation\">)</span>\n\nTest Suites: 1 passed, 1 total\nTests:       1 passed, 1 total\nSnapshots:   0 total\nTime:        1.645s, estimated 2s\nRan all <span class=\"token function\">test</span> suites.\n✨  Done <span class=\"token keyword\">in</span> 2.76s.</code></pre></div>\n<h1 id=\"storyshots-のセットアップ\"><a href=\"#storyshots-%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97\" aria-label=\"storyshots のセットアップ permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Storyshots のセットアップ</h1>\n<p><strong><a href=\"https://github.com/storybookjs/storybook/tree/master/addons/storyshots/storyshots-core\" target=\"_blank\" rel=\"noopener\">Storyshots</a></strong> は、<strong>Storybook で記述した Story をテストファイルと見立てて、そのレンダリング結果をスナップショットとして保存してくれるテスティングツールです</strong>。保存済みのスナップショットと、実行時のスナップショットが異なっている場合に、テストを Fail にしてくれます。コンポーネントの意図しないデグレを検知することができるようになります。</p>\n<h2 id=\"yarn-install-1\"><a href=\"#yarn-install-1\" aria-label=\"yarn install 1 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>yarn install</h2>\n<ul>\n<li>@storybook/addon-storyshots</li>\n<li>require.context を解決できる Babel plugin</li>\n<li>型情報</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> <span class=\"token function\">add</span> -DW @storybook/addon-storyshots react-test-renderer babel-plugin-require-context-hook @types/storybook__addon-storyshots</code></pre></div>\n<h2 id=\"srcclientjestconfigjs-1\"><a href=\"#srcclientjestconfigjs-1\" aria-label=\"srcclientjestconfigjs 1 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/src/client/jest.config.js</h2>\n<ul>\n<li><strong>setupFiles</strong>: Jest の初期化関数を追加します</li>\n</ul>\n<div class=\"gatsby-code-title\">/src/client/jest.config.js</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n<span class=\"gatsby-highlight-code-line\">  setupFiles<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'&lt;rootDir>/.jest/setup.js'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"srcclientjestsetupjs\"><a href=\"#srcclientjestsetupjs\" aria-label=\"srcclientjestsetupjs permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/src/client/.jest/setup.js</h2>\n<p>Storybook の初期化時に使用している require.context を Jest でも使用できるようにします（<a href=\"https://github.com/storybookjs/storybook/tree/master/addons/storyshots/storyshots-core#configure-jest-to-work-with-webpacks-requirecontext\" target=\"_blank\" rel=\"noopener\">※参照文献</a>）。babel-plugin-require-context-hook を使います；</p>\n<div class=\"gatsby-code-title\">/src/client/.jest/setup.js</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> registerRequireContextHook <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'babel-plugin-require-context-hook/register'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">registerRequireContextHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"srcclientsrccomponentsstoryshotstestjs\"><a href=\"#srcclientsrccomponentsstoryshotstestjs\" aria-label=\"srcclientsrccomponentsstoryshotstestjs permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/src/client/src/components/storyshots.test.js</h2>\n<p>Jest が Storyshots の起点とするテストファイルで、ここで Storyshots の初期化を行います。</p>\n<ul>\n<li><strong>configPath</strong>: Storybook の config を指定</li>\n<li><strong>test</strong>: どのようなスナップショットを出力するかを指定します。ここでは multiSnapshotWithOptions を指定することで、コンポーネントごとに 1 つずつスナップショットファイルを生成するようにしています</li>\n</ul>\n<div class=\"gatsby-code-title\">/src/client/src/components/storyshots.test.js</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> initStoryshots<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> multiSnapshotWithOptions <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@storybook/addon-storyshots'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// eslint-disable-line import/no-extraneous-dependencies</span>\n<span class=\"token keyword\">import</span> path <span class=\"token keyword\">from</span> <span class=\"token string\">'path'</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\"></span><span class=\"token function\">initStoryshots</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  configPath<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'../../.storybook/config.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  test<span class=\"token punctuation\">:</span> <span class=\"token function\">multiSnapshotWithOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"yarn-test\"><a href=\"#yarn-test\" aria-label=\"yarn test permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>yarn test</h2>\n<p>では実際に Storyshots を実行してみます。成功すると、スナップショットファイルが 1 つ生成されます；</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> <span class=\"token function\">test</span>\n\n PASS   client  src/client/src/components/storyshots.test.ts\n › 1 snapshot written.\n PASS   client  src/client/src/App.test.tsx\n\nSnapshot Summary\n › 1 snapshot written from 1 <span class=\"token function\">test</span> suite.\n\nTest Suites: 2 passed, 2 total\nTests:       2 passed, 2 total\nSnapshots:   1 written, 1 total\nTime:        4.32s\nRan all <span class=\"token function\">test</span> suites.\n✨  Done <span class=\"token keyword\">in</span> 5.44s.</code></pre></div>\n<h2 id=\"デグレ検知の実験\"><a href=\"#%E3%83%87%E3%82%B0%E3%83%AC%E6%A4%9C%E7%9F%A5%E3%81%AE%E5%AE%9F%E9%A8%93\" aria-label=\"デグレ検知の実験 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>デグレ検知の実験</h2>\n<p>スナップショットテストが正しく動作しているかをチェックするために、簡単にデグレを起こしてみましょう；</p>\n<div class=\"gatsby-code-title\">/src/client/src/components/organisms/BlogPost/index.tsx</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">BlogPost</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> post <span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span> BlogPostPresenterProps</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>Container<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>Header <span class=\"token keyword\">as</span><span class=\"token operator\">=</span><span class=\"token string\">\"h1\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>post<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Header<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>small<span class=\"token operator\">></span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token string\">`created at: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>post<span class=\"token punctuation\">.</span>createdAt<span class=\"token punctuation\">,</span> <span class=\"token string\">'yyyy/MM/dd'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>small<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>article className<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>styles<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>post<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>article<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>Author author<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>post<span class=\"token punctuation\">.</span>author<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span>デグレ検知<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>p<span class=\"token operator\">></span></span>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Container<span class=\"token operator\">></span></code></pre></div>\n<p>Storyshots を実行してみます。デグレを起こした部分が表示され、テストが正しく Fail します；</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> <span class=\"token function\">test</span>\n\n PASS   client  src/client/src/App.test.tsx\n FAIL   client  src/client/src/components/storyshots.test.ts\n  ● Storyshots › organisms/BlogPost › BlogPost\n\n    expect<span class=\"token punctuation\">(</span>received<span class=\"token punctuation\">)</span>.toMatchSnapshot<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    Snapshot name: <span class=\"token variable\"><span class=\"token variable\">`</span>Storyshots organisms/BlogPost BlogPost 1<span class=\"token variable\">`</span></span>\n\n    - Snapshot\n    + Received\n\n    @@ -91,10 +91,13 @@\n                  テスト太郎\n                <span class=\"token operator\">&lt;</span>/div<span class=\"token operator\">></span>\n                test@example.com\n              <span class=\"token operator\">&lt;</span>/div<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>/div<span class=\"token operator\">></span>\n<span class=\"gatsby-highlight-code-line\">    +       <span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span></span><span class=\"gatsby-highlight-code-line\">    +         デグレ検知</span><span class=\"gatsby-highlight-code-line\">    +       <span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span></span>          <span class=\"token operator\">&lt;</span>/div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>/div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>div\n            style<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n\n      at match <span class=\"token punctuation\">(</span><span class=\"token punctuation\">..</span>/<span class=\"token punctuation\">..</span>/node_modules/@storybook/addon-storyshots/dist/test-bodies.js:27:20<span class=\"token punctuation\">)</span>\n      at <span class=\"token punctuation\">..</span>/<span class=\"token punctuation\">..</span>/node_modules/@storybook/addon-storyshots/dist/test-bodies.js:39:10\n      at Object.<span class=\"token operator\">&lt;</span>anonymous<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">..</span>/<span class=\"token punctuation\">..</span>/node_modules/@storybook/addon-storyshots/dist/api/snapshotsTestsTemplate.js:42:33<span class=\"token punctuation\">)</span>\n\n › 1 snapshot failed.\nSnapshot Summary\n › 1 snapshot failed from 1 <span class=\"token function\">test</span> suite. Inspect your code changes or run <span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">yarn</span> <span class=\"token function\">test</span> -u<span class=\"token variable\">`</span></span> to update them.\n\nTest Suites: 1 failed, 1 passed, 2 total\nTests:       1 failed, 1 passed, 2 total\nSnapshots:   1 failed, 1 total\nTime:        4.289s\nRan all <span class=\"token function\">test</span> suites.\nerror Command failed with <span class=\"token keyword\">exit</span> code 1.\ninfo Visit https://yarnpkg.com/en/docs/cli/run <span class=\"token keyword\">for</span> documentation about this command.</code></pre></div>\n<p>わざとデグレを起こした部分を削除して保存し、改めて Storyshots を実行してみます。そうすると今回はテストが正常に終了します。これで導入成功です！</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> <span class=\"token function\">test</span>\n\n PASS   client  src/client/src/App.test.tsx\n PASS   client  src/client/src/components/storyshots.test.ts\n\nTest Suites: 2 passed, 2 total\nTests:       2 passed, 2 total\nSnapshots:   1 passed, 1 total\nTime:        3.131s\nRan all <span class=\"token function\">test</span> suites.\n✨  Done <span class=\"token keyword\">in</span> 3.94s.</code></pre></div>\n<h1 id=\"ロジックと-storyshots-のテストを分離\"><a href=\"#%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF%E3%81%A8-storyshots-%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E5%88%86%E9%9B%A2\" aria-label=\"ロジックと storyshots のテストを分離 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ロジックと Storyshots のテストを分離</h1>\n<p>現状のままだと、ロジックのテストと、Storyshots のテストが同時に走っています。コンポーネントのみのテストを行うために、Storyshots のテストを分離してみます。</p>\n<h2 id=\"srcclientsrccomponentsteststoryshotsts\"><a href=\"#srcclientsrccomponentsteststoryshotsts\" aria-label=\"srcclientsrccomponentsteststoryshotsts permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/src/client/src/components/test.storyshots.ts</h2>\n<p>Storyshots のテストを行うファイルを、通常のテストファイルのパターンから外れるようにリネームします。今回は <strong>storyshots.test.ts→test.storyshots.ts に変更しました</strong>。</p>\n<h2 id=\"srcclientjestconfigstoryshotsjs\"><a href=\"#srcclientjestconfigstoryshotsjs\" aria-label=\"srcclientjestconfigstoryshotsjs permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/src/client/jest.config.storyshots.js</h2>\n<p>通常の jest.config.js から、Storyshots のテストを行うための設定を分離します。具体的には testMatch を、Storyshots のテストを行うファイルのみをマッチさせるように上書きします；</p>\n<div class=\"gatsby-code-title\">/src/client/jest.config.storyshots.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> baseConfig <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./jest.config'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>baseConfig<span class=\"token punctuation\">,</span>\n  testMatch<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'&lt;rootDir>/**/test.storyshots.(js|jsx|ts|tsx)'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"srcclientpackagejson\"><a href=\"#srcclientpackagejson\" aria-label=\"srcclientpackagejson permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/src/client/package.json</h2>\n<p>テストを実行するスクリプトを、ロジック・Storyshots に分割します。Storyshots のテストについては、さきほと作成した config ファイルを使用するように変更しました；</p>\n<div class=\"gatsby-code-title\">/src/client/package.json</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"react-scripts start\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"react-scripts build\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"eject\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"react-scripts eject\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"storybook\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"start-storybook\"</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NODE_ENV=test jest\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token property\">\"storyshots\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NODE_ENV=test jest --config ./jest.config.storyshots.js\"</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<h2 id=\"packagejson\"><a href=\"#packagejson\" aria-label=\"packagejson permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/package.json</h2>\n<p>ルートの package.json も変更します。storyshots を実行するコマンドを、yarn workspace 経由で直接呼び出すように変更しました；</p>\n<div class=\"gatsby-code-title\">/package.json</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"cl:start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"yarn workspace client start\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"sr:start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"yarn workspace server start\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"lint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"yarn cl:lint &amp;&amp; yarn sr:lint\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"cl:lint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eslint --fix --ext .jsx,.js,.tsx,.ts ./src/client/src\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"sr:lint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eslint --fix --ext .jsx,.js,.tsx,.ts ./src/server/src\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"storybook\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"yarn workspace client storybook\"</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NODE_ENV=test jest\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token property\">\"storyshots\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"yarn workspace client storyshots\"</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<h2 id=\"実行\"><a href=\"#%E5%AE%9F%E8%A1%8C\" aria-label=\"実行 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実行</h2>\n<p>実行してみます。無事に成功しました！</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> storyshots\n\n$ <span class=\"token function\">yarn</span> workspace client storyshots\n$ NODE_ENV<span class=\"token operator\">=</span>test jest --config ./jest.config.storyshots.js\n PASS   client  src/components/test.storyshots.ts\n  Storyshots\n    organisms/BlogPost\n      ✓ BlogPost <span class=\"token punctuation\">(</span>37ms<span class=\"token punctuation\">)</span>\n\nTest Suites: 1 passed, 1 total\nTests:       1 passed, 1 total\nSnapshots:   1 passed, 1 total\nTime:        3.127s\nRan all <span class=\"token function\">test</span> suites.\n✨  Done <span class=\"token keyword\">in</span> 4.46s.</code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ab5c3e2846e5f7da99fe5fd41495f0a3/782f4/run-storyshots.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 480px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABVklEQVQoz3WSy07CQBSG+wqaiGBvlFpa7G16oYXSQilNRReYmBCWrFxATNz4EBof+nc6EYKkLL6cySTnyz/nDBeOY8RxhOl0hiRJQDyCMAjgui6i4RBBEML3fWiaBsMwoOs6YzAYQO/rUFUVkiRBFEVWubv9M94/P/Dz9Y3dbs8aawjxmJQQgjzPkaYZFmWJqqqQZRm77/V6jH/C4qnCdrvFZrNBURSYz+eYpBMoigJZlhndbvdYD+daIAgCqwdZXblOp4N7vQ/zwYRr2fAMC4Ht0iYJ7XYb/EnTObXkwDHhbDZFlqaIRjFavo7rVYhW4cAyTeQ0revYLMlp87nkFG69XmOSjGlKDbc5wdVbjpvXGL7nYfXygigMwPN8o7AJ7nG5hGVZbFvOKESyKqE6BhQ6qz7dZj30piQXheWioN+EiiYpFnQpvu1AFujA/4YuCOLF5zXxC+OC7castKeaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"run storyshots\"\n        title=\"\"\n        src=\"/static/ab5c3e2846e5f7da99fe5fd41495f0a3/782f4/run-storyshots.png\"\n        srcset=\"/static/ab5c3e2846e5f7da99fe5fd41495f0a3/cf440/run-storyshots.png 148w,\n/static/ab5c3e2846e5f7da99fe5fd41495f0a3/d2d38/run-storyshots.png 295w,\n/static/ab5c3e2846e5f7da99fe5fd41495f0a3/782f4/run-storyshots.png 480w\"\n        sizes=\"(max-width: 480px) 100vw, 480px\"\n      />\n  </span>\n  </a></p>\n<h1 id=\"note\"><a href=\"#note\" aria-label=\"note permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NOTE</h1>\n<h2 id=\"現在の-config-設定を表示する\"><a href=\"#%E7%8F%BE%E5%9C%A8%E3%81%AE-config-%E8%A8%AD%E5%AE%9A%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\" aria-label=\"現在の config 設定を表示する permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>現在の Config 設定を表示する</h2>\n<p>設定がうまく反映されているか自信がない場合、Jest の Config を表示させて確認してみると良いです；</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ jest --showConfig</code></pre></div>\n<p>projects に指定した client と server の設定が configs の配列となって格納されています。それ以外にも global の config や version 情報などが表示されます；</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"configs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"cwd\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/Users/suzukalight/work/monorepo-react-prisma2\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"client\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"moduleFileExtensions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"js\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"json\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"jsx\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ts\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"tsx\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"node\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"moduleNameMapper\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"\\\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga)$\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"/Users/suzukalight/work/monorepo-react-prisma2/src/client/.jest/__mocks__/file.js\"</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"\\\\.(styl|css|less|scss)$\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"/Users/suzukalight/work/monorepo-react-prisma2/src/client/.jest/__mocks__/style.js\"</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"rootDir\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/Users/suzukalight/work/monorepo-react-prisma2/src/client\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"transform\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"^.+\\\\.(js|jsx|ts|tsx)$\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"/Users/suzukalight/work/monorepo-react-prisma2/src/client/.jest/transform.js\"</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"rootDir\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/Users/suzukalight/work/monorepo-react-prisma2/src/server\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"globalConfig\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"projects\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"/Users/suzukalight/work/monorepo-react-prisma2/src/client\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"/Users/suzukalight/work/monorepo-react-prisma2/src/server\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"rootDir\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/Users/suzukalight/work/monorepo-react-prisma2\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"24.9.0\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"キャッシュをクリアする\"><a href=\"#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E3%82%AF%E3%83%AA%E3%82%A2%E3%81%99%E3%82%8B\" aria-label=\"キャッシュをクリアする permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>キャッシュをクリアする</h2>\n<p>Jest のキャッシュをクリアするには、<code class=\"language-text\">--clearCache</code> オプションを指定して Jest を実行します；</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ jest --clearCache</code></pre></div>\n<h2 id=\"srcclientbabelrcjs-を置いてはダメなの？\"><a href=\"#srcclientbabelrcjs-%E3%82%92%E7%BD%AE%E3%81%84%E3%81%A6%E3%81%AF%E3%83%80%E3%83%A1%E3%81%AA%E3%81%AE%EF%BC%9F\" aria-label=\"srcclientbabelrcjs を置いてはダメなの？ permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>/src/client/.babelrc.js を置いてはダメなの？</h2>\n<p>/src/client/.babelrc.js を置いた場合、Storybook の Webpack も、この RC ファイルを読みに来ます。ここで Jest と Storybook の設定がバッティングしてしまい、うまく動作させられませんでした。今回は babel-jest の createTransformer で設定を分けることができたので、それで対処しています。</p>\n<h1 id=\"完成品-1\"><a href=\"#%E5%AE%8C%E6%88%90%E5%93%81-1\" aria-label=\"完成品 1 permalink\" class=\"gatsby-autolink-headers\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>完成品</h1>\n<p>実装内容をプルリクエストにしたものを、GitHub 上に公開していますので、併せてご参照ください。</p>\n<ul>\n<li><a href=\"https://github.com/suzukalight/monorepo-react-prisma2/pull/2\" target=\"_blank\" rel=\"noopener\">https://github.com/suzukalight/monorepo-react-prisma2/pull/2</a></li>\n<li><a href=\"https://github.com/suzukalight/monorepo-react-prisma2/pull/3\" target=\"_blank\" rel=\"noopener\">https://github.com/suzukalight/monorepo-react-prisma2/pull/3</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"/2019-09-03-monorepo-jest-storyshots/#%E3%81%BE%E3%81%88%E3%81%8C%E3%81%8D\">まえがき</a></p>\n<ul>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#%E5%AE%8C%E6%88%90%E5%93%81\">完成品</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#%E5%8B%95%E4%BD%9C%E7%92%B0%E5%A2%83\">動作環境</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/2019-09-03-monorepo-jest-storyshots/#jest-%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97\">Jest のセットアップ</a></p>\n<ul>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#yarn-install\">yarn install</a></li>\n<li>\n<p><a href=\"/2019-09-03-monorepo-jest-storyshots/#global-config\">global config</a></p>\n<ul>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#babelconfigjs\">/babel.config.js</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#jestconfigjs\">/jest.config.js</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"/2019-09-03-monorepo-jest-storyshots/#client-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97\">client プロジェクトのセットアップ</a></p>\n<ul>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#srcclientjestconfigjs\">/src/client/jest.config.js</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#srcclientjesttransformjs\">/src/client/.jest/transform.js</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#mocks\">Mocks</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#%E3%83%86%E3%82%B9%E3%83%88%E5%AE%9F%E8%A1%8C\">テスト実行</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/2019-09-03-monorepo-jest-storyshots/#storyshots-%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97\">Storyshots のセットアップ</a></p>\n<ul>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#yarn-install-1\">yarn install</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#srcclientjestconfigjs-1\">/src/client/jest.config.js</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#srcclientjestsetupjs\">/src/client/.jest/setup.js</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#srcclientsrccomponentsstoryshotstestjs\">/src/client/src/components/storyshots.test.js</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#yarn-test\">yarn test</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#%E3%83%87%E3%82%B0%E3%83%AC%E6%A4%9C%E7%9F%A5%E3%81%AE%E5%AE%9F%E9%A8%93\">デグレ検知の実験</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/2019-09-03-monorepo-jest-storyshots/#%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF%E3%81%A8-storyshots-%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E5%88%86%E9%9B%A2\">ロジックと Storyshots のテストを分離</a></p>\n<ul>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#srcclientsrccomponentsteststoryshotsts\">/src/client/src/components/test.storyshots.ts</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#srcclientjestconfigstoryshotsjs\">/src/client/jest.config.storyshots.js</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#srcclientpackagejson\">/src/client/package.json</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#packagejson\">/package.json</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#%E5%AE%9F%E8%A1%8C\">実行</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/2019-09-03-monorepo-jest-storyshots/#note\">NOTE</a></p>\n<ul>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#%E7%8F%BE%E5%9C%A8%E3%81%AE-config-%E8%A8%AD%E5%AE%9A%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\">現在の Config 設定を表示する</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E3%82%AF%E3%83%AA%E3%82%A2%E3%81%99%E3%82%8B\">キャッシュをクリアする</a></li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#srcclientbabelrcjs-%E3%82%92%E7%BD%AE%E3%81%84%E3%81%A6%E3%81%AF%E3%83%80%E3%83%A1%E3%81%AA%E3%81%AE%EF%BC%9F\">/src/client/.babelrc.js を置いてはダメなの？</a></li>\n</ul>\n</li>\n<li><a href=\"/2019-09-03-monorepo-jest-storyshots/#%E5%AE%8C%E6%88%90%E5%93%81-1\">完成品</a></li>\n</ul>","frontmatter":{"title":"monorepo環境にJestとStoryshotsのレグレッションテスト環境を構築","date":"2019-09-03T00:02:00","description":null,"category":"Technology","tags":["monorepo","jest","storyshots","typescript","storybook"],"hero":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABVklEQVQoz3WSy07CQBSG+wqaiGBvlFpa7G16oYXSQilNRReYmBCWrFxATNz4EBof+nc6EYKkLL6cySTnyz/nDBeOY8RxhOl0hiRJQDyCMAjgui6i4RBBEML3fWiaBsMwoOs6YzAYQO/rUFUVkiRBFEVWubv9M94/P/Dz9Y3dbs8aawjxmJQQgjzPkaYZFmWJqqqQZRm77/V6jH/C4qnCdrvFZrNBURSYz+eYpBMoigJZlhndbvdYD+daIAgCqwdZXblOp4N7vQ/zwYRr2fAMC4Ht0iYJ7XYb/EnTObXkwDHhbDZFlqaIRjFavo7rVYhW4cAyTeQ0revYLMlp87nkFG69XmOSjGlKDbc5wdVbjpvXGL7nYfXygigMwPN8o7AJ7nG5hGVZbFvOKESyKqE6BhQ6qz7dZj30piQXheWioN+EiiYpFnQpvu1AFujA/4YuCOLF5zXxC+OC7castKeaAAAAAElFTkSuQmCC","aspectRatio":2.0416666666666665,"src":"/static/ab5c3e2846e5f7da99fe5fd41495f0a3/b262b/run-storyshots.png","srcSet":"/static/ab5c3e2846e5f7da99fe5fd41495f0a3/d0480/run-storyshots.png 245w,\n/static/ab5c3e2846e5f7da99fe5fd41495f0a3/b262b/run-storyshots.png 480w","sizes":"(max-width: 480px) 100vw, 480px"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"source":"github","slug":"/2019-09-03-monorepo-jest-storyshots/","previous":{"head":{"title":"Storybookでコンポーネントの型情報を表示する","category":"Technology","tags":["monorepo","storybook","create-react-app","typescript"],"date":"2019-08-31T00:02:00","slug":"/2019-08-31-storybook/","source":"github"},"siteMetadata":{"title":"suzukalight.com"}},"next":{"head":{"title":"【一口馬主】キャロットクラブ新規入会・攻略の顛末（随時更新）","category":"競馬","tags":["競馬","キャロットクラブ","一口馬主"],"date":"2019-09-06T00:02:00","slug":"/2019-09-06-join-carrot-club/","source":"github"},"siteMetadata":{"title":"suzukalight.com"}}}}}